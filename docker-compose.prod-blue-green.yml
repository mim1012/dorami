version: '3.8'

services:
  # Blue application stack
  backend_blue:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/dorami-backend:${IMAGE_TAG:?IMAGE_TAG required}
    container_name: dorami-backend-blue
    restart: always
    expose:
      - '3001'
    environment:
      NODE_ENV: production
      APP_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-warn}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public&connection_limit=20&pool_timeout=30
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PUBSUB_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required (64+ chars)}
      PROFILE_ENCRYPTION_KEY: ${PROFILE_ENCRYPTION_KEY:?PROFILE_ENCRYPTION_KEY required}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID:?KAKAO_CLIENT_ID required}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET:?KAKAO_CLIENT_SECRET required}
      KAKAO_CALLBACK_URL: ${KAKAO_CALLBACK_URL:?KAKAO_CALLBACK_URL required}
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL required}
      CORS_ORIGINS: ${CORS_ORIGINS:?CORS_ORIGINS required}
      RTMP_SERVER_URL: rtmp://srs:1935/live
      HLS_SERVER_URL: http://srs:8080/hls
      CSRF_ENABLED: 'true'
      DISABLE_CSRF: 'false'
      COOKIE_SECURE: 'true'
      ENABLE_DEV_AUTH: 'false'
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - dorami-internal

  frontend_blue:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/dorami-frontend:${IMAGE_TAG:?IMAGE_TAG required}
    container_name: dorami-frontend-blue
    restart: always
    expose:
      - '3000'
    environment:
      NODE_ENV: production
      APP_ENV: production
      BACKEND_URL: http://backend_blue:3001
      HOSTNAME: 0.0.0.0
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:?NEXT_PUBLIC_API_URL required}
      NEXT_PUBLIC_WS_URL: ${WS_URL:-}
      NEXT_PUBLIC_CDN_URL: ${NEXT_PUBLIC_CDN_URL:-}
      NEXT_PUBLIC_ENABLE_DEV_AUTH: 'false'
      NEXT_PUBLIC_PREVIEW_ENABLED: 'false'
      NEXT_PUBLIC_KAKAO_JS_KEY: ${NEXT_PUBLIC_KAKAO_JS_KEY:-}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN:-}
      NEXT_PUBLIC_APP_VERSION: ${APP_VERSION:-1.0.0}
    depends_on:
      - backend_blue
    networks:
      - dorami-internal

  # Green application stack
  backend_green:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/dorami-backend:${IMAGE_TAG:?IMAGE_TAG required}
    container_name: dorami-backend-green
    restart: always
    expose:
      - '3001'
    environment:
      NODE_ENV: production
      APP_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-warn}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public&connection_limit=20&pool_timeout=30
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PUBSUB_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required (64+ chars)}
      PROFILE_ENCRYPTION_KEY: ${PROFILE_ENCRYPTION_KEY:?PROFILE_ENCRYPTION_KEY required}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID:?KAKAO_CLIENT_ID required}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET:?KAKAO_CLIENT_SECRET required}
      KAKAO_CALLBACK_URL: ${KAKAO_CALLBACK_URL:?KAKAO_CALLBACK_URL required}
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL required}
      CORS_ORIGINS: ${CORS_ORIGINS:?CORS_ORIGINS required}
      RTMP_SERVER_URL: rtmp://srs:1935/live
      HLS_SERVER_URL: http://srs:8080/hls
      CSRF_ENABLED: 'true'
      DISABLE_CSRF: 'false'
      COOKIE_SECURE: 'true'
      ENABLE_DEV_AUTH: 'false'
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - dorami-internal

  frontend_green:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/dorami-frontend:${IMAGE_TAG:?IMAGE_TAG required}
    container_name: dorami-frontend-green
    restart: always
    expose:
      - '3000'
    environment:
      NODE_ENV: production
      APP_ENV: production
      BACKEND_URL: http://backend_green:3001
      HOSTNAME: 0.0.0.0
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:?NEXT_PUBLIC_API_URL required}
      NEXT_PUBLIC_WS_URL: ${WS_URL:-}
      NEXT_PUBLIC_CDN_URL: ${NEXT_PUBLIC_CDN_URL:-}
      NEXT_PUBLIC_ENABLE_DEV_AUTH: 'false'
      NEXT_PUBLIC_PREVIEW_ENABLED: 'false'
      NEXT_PUBLIC_KAKAO_JS_KEY: ${NEXT_PUBLIC_KAKAO_JS_KEY:-}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN:-}
      NEXT_PUBLIC_APP_VERSION: ${APP_VERSION:-1.0.0}
    depends_on:
      - backend_green
    networks:
      - dorami-internal

  # Canary Nginx for pre-switch validation.
  # Mounted routing template is generated by streaming-blue-green script.
  nginx_blue_green_canary:
    image: nginx:alpine
    container_name: dorami-nginx-blue-green-canary
    restart: unless-stopped
    profiles: [canary]
    ports:
      - "13080:80"
    depends_on:
      - backend_blue
      - frontend_blue
      - backend_green
      - frontend_green
      - srs
    volumes:
      - ./nginx/production-canary.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/streaming-routing.blue-green.conf:/etc/nginx/conf.d/streaming-routing.conf:ro
    networks:
      - dorami-internal

networks:
  dorami-internal:
    external: true
    name: ${DORAMI_INTERNAL_NETWORK:-dorami_dorami-internal}
