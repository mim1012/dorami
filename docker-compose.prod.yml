# Docker Compose Production Overlay
# 사용법: docker-compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d
# Env: --env-file .env.production
#
# 특징:
# - Nginx 컨테이너가 80/443 포트 처리 (SSL termination, reverse proxy)
# - 리소스 제한: CPU/Memory 제한
# - 로깅: max-size/file 지정
# - 환경변수: 모두 필수 (:? 검증)
# - 네트워크: dorami-internal (internal=false for outbound)

version: '3.8'

services:
  postgres:
    container_name: dorami-postgres-prod
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB required}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: 5
    networks:
      - dorami-internal

  redis:
    container_name: dorami-redis-prod
    restart: always
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      REDIS_MAXMEMORY: 512mb
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: 20m
        max-file: 3
    networks:
      - dorami-internal

  backend:
    container_name: dorami-backend-prod
    restart: always
    ports:
      - '127.0.0.1:3001:3001'  # Nginx container proxy only
    environment:
      NODE_ENV: production
      APP_ENV: production
      PORT: 3001
      LOG_LEVEL: ${LOG_LEVEL:-warn}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public&connection_limit=20&pool_timeout=30
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PUBSUB_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required (64+ chars)}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID:?KAKAO_CLIENT_ID required}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET:?KAKAO_CLIENT_SECRET required}
      KAKAO_CALLBACK_URL: ${KAKAO_CALLBACK_URL:?KAKAO_CALLBACK_URL required}
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL required}
      CORS_ORIGINS: ${CORS_ORIGINS:?CORS_ORIGINS required}
      CSRF_ENABLED: 'true'
      COOKIE_SECURE: 'true'
      ENABLE_DEV_AUTH: 'false'
      PROFILE_ENCRYPTION_KEY: ${PROFILE_ENCRYPTION_KEY:?PROFILE_ENCRYPTION_KEY required}
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      RTMP_SERVER_URL: rtmp://srs:1935/live
      HLS_SERVER_URL: http://srs:8080/hls
      SENTRY_DSN: ${SENTRY_DSN:-}
      APP_VERSION: ${APP_VERSION:-1.0.0}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    volumes:
      - uploads_data:/app/uploads:rw
    logging:
      driver: json-file
      options:
        max-size: 100m
        max-file: 10
    networks:
      - dorami-internal

  frontend:
    container_name: dorami-frontend-prod
    restart: always
    ports:
      - '127.0.0.1:3000:3000'  # Nginx container proxy only
    environment:
      NODE_ENV: production
      APP_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:?NEXT_PUBLIC_API_URL required}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:?NEXT_PUBLIC_WS_URL required}
      NEXT_PUBLIC_CDN_URL: ${NEXT_PUBLIC_CDN_URL:-}
      NEXT_PUBLIC_ENABLE_DEV_AUTH: 'false'
      NEXT_PUBLIC_PREVIEW_ENABLED: 'false'
      NEXT_PUBLIC_KAKAO_JS_KEY: ${KAKAO_JS_KEY:?KAKAO_JS_KEY required}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN:-}
      NEXT_PUBLIC_APP_VERSION: ${APP_VERSION:-1.0.0}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: 5
    networks:
      - dorami-internal

  srs:
    image: ossrs/srs:6
    container_name: dorami-srs-prod
    restart: always
    ports:
      - '1935:1935'  # RTMP ingest
      - '127.0.0.1:8080:8080'  # HTTP-FLV + HLS (Nginx container proxy)
    volumes:
      - ./infrastructure/docker/srs/srs.conf:/usr/local/srs/conf/docker.conf:ro
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: 100m
        max-file: 10
    networks:
      - dorami-internal

  nginx:
    image: nginx:alpine
    container_name: dorami-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/production.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
      - uploads_data:/var/www/uploads:ro
    depends_on:
      - backend
      - frontend
      - srs
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dorami-internal

volumes:
  uploads_data:
    driver: local

networks:
  dorami-internal:
    driver: bridge
    internal: false  # Allow outbound internet (OAuth, Sentry, etc.)
