# Shared streaming-related routing blocks for staging / production nginx.
#
# This file is intentionally included by both nginx/staging.conf and
# nginx/production.conf to prevent route drift on:
# - upstream definitions (backend/frontend/srs)
# - HTTP-FLV /live endpoints
# - HLS endpoints
# - websocket /socket.io upgrade path

upstream backend {
    server backend:3001;
    keepalive 32;
}

upstream frontend {
    server frontend:3000;
    keepalive 32;
}

upstream srs {
    server srs:8080;
    keepalive 32;
}

# HTTP-FLV (low-latency, primary streaming path)
# /live/live/{streamKey}.flv
location /live/live/ {
    proxy_pass http://srs/live/live/;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    chunked_transfer_encoding on;
    add_header Access-Control-Allow-Origin * always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
}

# HLS media playlist + TS segments
location ~ ^/live/[^/]+\.(m3u8|ts) {
    proxy_pass http://srs;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Access-Control-Allow-Origin * always;
}

# Block /hls/hls/ CDN conflict path
location /hls/hls/ {
    return 404;
}

# HLS master playlist + TS segment fallback path
location /hls/ {
    proxy_pass http://srs/live/;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Access-Control-Allow-Origin * always;
}

# WebSocket endpoint (Socket.IO)
location /socket.io/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
}
