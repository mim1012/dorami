# Blue/Green routing template for frontend/backend swap.
# Streaming-blue-green deployment script replaces:
#   - __BACKEND_SLOT__ => backend_blue | backend_green
#   - __FRONTEND_SLOT__ => frontend_blue | frontend_green
#
# Keep in sync with production/staging routing policy.

upstream backend {
    server __BACKEND_SLOT__:3001;
    keepalive 32;
}

upstream frontend {
    server __FRONTEND_SLOT__:3000;
    keepalive 32;
}

upstream srs {
    server srs:8080;
    keepalive 32;
}

location /live/live/ {
    proxy_pass http://srs/live/live/;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    chunked_transfer_encoding on;
    add_header Access-Control-Allow-Origin * always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
}

location ~ ^/live/[^/]+\.(m3u8|ts) {
    proxy_pass http://srs;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Access-Control-Allow-Origin * always;
}

location /hls/hls/ {
    return 404;
}

location /hls/ {
    proxy_pass http://srs/live/;
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_buffering off;
    proxy_request_buffering off;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Access-Control-Allow-Origin * always;
}

location /socket.io/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
}

location / {
    proxy_pass http://frontend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

