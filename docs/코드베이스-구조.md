# Dorami - 라이브 커머스 플랫폼 코드베이스 구조

## 개요

Dorami는 1인 셀러를 위한 라이브 커머스 MVP 플랫폼입니다. 모노레포 구조로 백엔드, 프론트엔드, 공유 패키지가 하나의 저장소에서 관리됩니다.

## 기술 스택

| 영역 | 기술 |
|------|------|
| **Frontend** | Next.js 16 (App Router), TypeScript, Tailwind CSS, TanStack Query |
| **Backend** | NestJS, TypeScript, Prisma ORM, PostgreSQL, Redis |
| **실시간** | Socket.IO (채팅), HLS.js (스트리밍) |
| **스트리밍** | nginx-rtmp, FFmpeg, HLS |
| **인증** | 카카오 OAuth, JWT |
| **인프라** | Docker, AWS CDK |

---

## 프로젝트 루트 구조

```
dorami/
├── backend/                      # NestJS 백엔드 서버
├── client-app/                   # Next.js 프론트엔드
├── packages/                     # 공유 패키지 (모노레포)
├── infrastructure/               # 인프라/배포 설정
├── docs/                         # 프로젝트 문서
├── _bmad/                        # BMAD 방법론 설정
├── .claude/                      # Claude Code 설정
├── ui frame/                     # UI 디자인 참고 이미지
├── docker-compose.yml            # 로컬 개발용 Docker
└── package.json                  # 루트 모노레포 설정 (npm workspaces)
```

---

## 1. Backend (`backend/`)

NestJS 기반 REST API 및 WebSocket 서버

```
backend/
├── src/
│   ├── main.ts                   # 앱 진입점 (부트스트랩)
│   ├── app.module.ts             # 루트 모듈
│   ├── app.controller.ts         # 헬스체크 컨트롤러
│   ├── app.service.ts
│   │
│   ├── common/                   # 공통 유틸리티
│   │   ├── prisma/
│   │   │   ├── prisma.module.ts
│   │   │   └── prisma.service.ts # Prisma 클라이언트 서비스
│   │   │
│   │   ├── redis/
│   │   │   ├── redis.module.ts
│   │   │   └── redis.service.ts  # Redis 캐시 서비스
│   │   │
│   │   ├── logger/
│   │   │   ├── logger.module.ts
│   │   │   └── logger.service.ts # 커스텀 로거
│   │   │
│   │   ├── guards/
│   │   │   └── roles.guard.ts    # 역할 기반 접근 제어
│   │   │
│   │   ├── decorators/
│   │   │   └── roles.decorator.ts # @Roles() 데코레이터
│   │   │
│   │   ├── filters/
│   │   │   └── business-exception.filter.ts # 비즈니스 예외 처리
│   │   │
│   │   ├── interceptors/
│   │   │   └── transform.interceptor.ts # 응답 형식 통일
│   │   │
│   │   ├── exceptions/
│   │   │   └── business.exception.ts # 커스텀 비즈니스 예외
│   │   │
│   │   ├── adapters/
│   │   │   └── redis-io.adapter.ts # Socket.IO Redis 어댑터
│   │   │
│   │   ├── middleware/
│   │   │   └── ws-jwt-auth.middleware.ts # WebSocket JWT 인증
│   │   │
│   │   ├── services/
│   │   │   └── encryption.service.ts # AES-256-GCM 암호화
│   │   │
│   │   ├── events/               # 이벤트 정의
│   │   │   ├── order.events.ts
│   │   │   └── product.events.ts
│   │   │
│   │   └── validators/
│   │       └── us-state.validator.ts
│   │
│   └── modules/                  # 기능 모듈 (도메인별 분리)
│       │
│       ├── auth/                 # 인증 모듈
│       │   ├── auth.module.ts
│       │   ├── auth.controller.ts
│       │   ├── auth.service.ts
│       │   ├── dto/
│       │   │   └── auth.dto.ts
│       │   ├── strategies/
│       │   │   ├── jwt.strategy.ts    # JWT 검증
│       │   │   └── kakao.strategy.ts  # 카카오 OAuth
│       │   ├── guards/
│       │   │   ├── jwt-auth.guard.ts
│       │   │   └── kakao-auth.guard.ts
│       │   └── decorators/
│       │       ├── current-user.decorator.ts # @CurrentUser()
│       │       └── public.decorator.ts       # @Public()
│       │
│       ├── admin/                # 관리자 모듈
│       │   ├── admin.module.ts
│       │   ├── admin.controller.ts
│       │   ├── admin.service.ts
│       │   └── dto/
│       │       └── admin.dto.ts
│       │
│       ├── products/             # 상품 모듈
│       │   ├── products.module.ts
│       │   ├── products.controller.ts
│       │   ├── products.service.ts
│       │   └── dto/
│       │
│       ├── orders/               # 주문 모듈
│       │   ├── orders.module.ts
│       │   ├── orders.controller.ts
│       │   ├── orders.service.ts
│       │   ├── inventory.service.ts  # 재고 관리
│       │   └── dto/
│       │
│       ├── cart/                 # 장바구니 모듈
│       │   ├── cart.module.ts
│       │   ├── cart.controller.ts
│       │   ├── cart.service.ts
│       │   ├── dto/
│       │   └── listeners/
│       │       └── cart-events.listener.ts
│       │
│       ├── reservation/          # 예약 대기열 모듈
│       │   ├── reservation.module.ts
│       │   └── reservation.service.ts
│       │
│       ├── streaming/            # 라이브 스트리밍 모듈 ⭐
│       │   ├── streaming.module.ts
│       │   ├── streaming.controller.ts
│       │   ├── streaming.service.ts
│       │   ├── streaming.gateway.ts  # WebSocket 게이트웨이
│       │   └── dto/
│       │       └── streaming.dto.ts
│       │
│       ├── chat/                 # 실시간 채팅 모듈
│       │   ├── chat.module.ts
│       │   └── chat.gateway.ts   # WebSocket 게이트웨이
│       │
│       ├── notices/              # 공지사항 모듈
│       │   ├── notices.module.ts
│       │   ├── notices.controller.ts
│       │   ├── notices.service.ts
│       │   └── dto/
│       │
│       ├── notifications/        # 알림 모듈
│       │   └── clients/
│       │       └── kakao-talk.client.ts # 카카오톡 알림
│       │
│       ├── settlement/           # 정산 모듈
│       │   ├── settlement.module.ts
│       │   ├── settlement.controller.ts
│       │   └── settlement.service.ts
│       │
│       ├── store/                # 스토어 정보 모듈
│       │   ├── store.module.ts
│       │   └── store.controller.ts
│       │
│       └── upload/               # 파일 업로드 모듈
│           ├── upload.module.ts
│           └── upload.controller.ts
│
├── prisma/
│   ├── schema.prisma             # 데이터베이스 스키마 정의
│   └── seed.ts                   # 시드 데이터
│
├── test/                         # E2E 테스트
│   └── *.e2e-spec.ts
│
├── nginx/                        # 로컬 Nginx 설정
│   └── nginx.conf
│
├── .env.example                  # 환경변수 예시
├── .env.test                     # 테스트 환경변수
├── docker-compose.yml            # 백엔드용 Docker 설정
├── jest.config.js                # Jest 테스트 설정
├── tsconfig.json                 # TypeScript 설정
└── package.json
```

### 주요 API 엔드포인트

| 모듈 | 엔드포인트 | 설명 |
|------|-----------|------|
| Auth | `GET /auth/kakao` | 카카오 로그인 |
| Auth | `POST /auth/logout` | 로그아웃 |
| Products | `GET /products` | 상품 목록 |
| Products | `GET /products/featured` | 추천 상품 |
| Orders | `POST /orders` | 주문 생성 |
| Orders | `GET /orders` | 주문 내역 |
| Cart | `GET /cart` | 장바구니 조회 |
| Cart | `POST /cart/items` | 장바구니 추가 |
| Streaming | `POST /streaming/generate-key` | 스트림 키 발급 |
| Streaming | `POST /streaming/auth` | RTMP 인증 콜백 |
| Streaming | `POST /streaming/done` | RTMP 종료 콜백 |
| Admin | `GET /admin/dashboard` | 대시보드 통계 |

---

## 2. Client App (`client-app/`)

Next.js 16 App Router 기반 프론트엔드

```
client-app/
├── src/
│   ├── app/                      # Next.js App Router (페이지)
│   │   ├── layout.tsx            # 루트 레이아웃 (다크 테마)
│   │   ├── page.tsx              # 홈페이지 (/)
│   │   ├── globals.css           # 글로벌 스타일 (Tailwind)
│   │   │
│   │   ├── (auth)/               # 인증 라우트 그룹
│   │   │   └── login/
│   │   │       └── page.tsx      # 로그인 페이지
│   │   │
│   │   ├── admin/                # 관리자 페이지 (/admin/*)
│   │   │   ├── layout.tsx        # 관리자 레이아웃 (흰색 테마)
│   │   │   ├── page.tsx          # 관리자 홈 (리다이렉트)
│   │   │   ├── dashboard/
│   │   │   │   └── page.tsx      # 대시보드
│   │   │   ├── products/
│   │   │   │   └── page.tsx      # 상품 관리
│   │   │   ├── orders/
│   │   │   │   ├── page.tsx      # 주문 관리
│   │   │   │   └── bulk-notify/
│   │   │   │       └── page.tsx  # 일괄 알림
│   │   │   ├── users/
│   │   │   │   ├── page.tsx      # 회원 목록
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx  # 회원 상세
│   │   │   ├── broadcasts/
│   │   │   │   └── page.tsx      # 방송 관리
│   │   │   ├── settlement/
│   │   │   │   └── page.tsx      # 정산 관리
│   │   │   ├── settings/
│   │   │   │   ├── page.tsx      # 설정
│   │   │   │   └── notifications/
│   │   │   │       └── page.tsx  # 알림 설정
│   │   │   └── audit-log/
│   │   │       └── page.tsx      # 감사 로그
│   │   │
│   │   ├── live/                 # 라이브 방송 (/live/*)
│   │   │   ├── page.tsx          # 라이브 목록
│   │   │   └── [streamKey]/
│   │   │       └── page.tsx      # 라이브 시청 페이지
│   │   │
│   │   ├── cart/
│   │   │   └── page.tsx          # 장바구니
│   │   │
│   │   ├── checkout/
│   │   │   └── page.tsx          # 결제 페이지
│   │   │
│   │   ├── orders/
│   │   │   ├── page.tsx          # 주문 내역
│   │   │   └── [orderId]/
│   │   │       └── page.tsx      # 주문 상세
│   │   │
│   │   ├── order-complete/
│   │   │   └── page.tsx          # 주문 완료
│   │   │
│   │   ├── products/
│   │   │   └── [id]/
│   │   │       └── page.tsx      # 상품 상세
│   │   │
│   │   ├── shop/
│   │   │   └── page.tsx          # 상품 목록
│   │   │
│   │   ├── store/
│   │   │   └── page.tsx          # 스토어 정보
│   │   │
│   │   ├── my-page/
│   │   │   ├── page.tsx          # 마이페이지
│   │   │   └── reservations/
│   │   │       └── page.tsx      # 예약 내역
│   │   │
│   │   ├── profile/
│   │   │   └── register/
│   │   │       └── page.tsx      # 프로필 등록
│   │   │
│   │   ├── alerts/
│   │   │   └── page.tsx          # 알림 목록
│   │   │
│   │   └── design-system-demo/
│   │       └── page.tsx          # 디자인 시스템 데모
│   │
│   ├── components/               # React 컴포넌트
│   │   ├── common/               # 공통 UI 컴포넌트
│   │   │   ├── Button.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Modal.tsx
│   │   │   ├── Pagination.tsx
│   │   │   ├── SearchBar.tsx
│   │   │   └── Toast.tsx
│   │   │
│   │   ├── admin/                # 관리자 전용 컴포넌트
│   │   │   ├── layout/
│   │   │   │   ├── Header.tsx    # 관리자 헤더
│   │   │   │   └── Sidebar.tsx   # 관리자 사이드바
│   │   │   ├── dashboard/
│   │   │   │   └── StatCard.tsx  # 통계 카드
│   │   │   └── settings/
│   │   │       └── NoticeManagement.tsx
│   │   │
│   │   ├── stream/               # 스트리밍 컴포넌트 ⭐
│   │   │   ├── VideoPlayer.tsx   # HLS 비디오 플레이어
│   │   │   ├── LiveBadge.tsx     # LIVE 배지
│   │   │   ├── ViewerCount.tsx   # 시청자 수
│   │   │   ├── PlayerControls.tsx # 플레이어 컨트롤
│   │   │   ├── BufferingSpinner.tsx
│   │   │   ├── ErrorOverlay.tsx
│   │   │   └── StreamEndedOverlay.tsx
│   │   │
│   │   ├── video/
│   │   │   └── VideoPlayer.tsx   # 범용 비디오 플레이어
│   │   │
│   │   ├── chat/                 # 채팅 컴포넌트
│   │   │   ├── ChatOverlay.tsx
│   │   │   ├── ChatHeader.tsx
│   │   │   ├── ChatInput.tsx
│   │   │   ├── ChatMessage.tsx
│   │   │   ├── ChatMessageList.tsx
│   │   │   ├── EmojiPicker.tsx
│   │   │   └── types.ts
│   │   │
│   │   ├── cart/
│   │   │   └── CartTimer.tsx     # 장바구니 타이머
│   │   │
│   │   ├── notices/
│   │   │   └── NoticeBox.tsx     # 공지사항 박스
│   │   │
│   │   └── auth/
│   │       └── ProtectedRoute.tsx # 인증 필요 라우트
│   │
│   ├── lib/                      # 유틸리티 라이브러리
│   │   ├── api/                  # API 클라이언트
│   │   │   ├── client.ts         # Axios 인스턴스
│   │   │   ├── products.ts       # 상품 API
│   │   │   ├── orders.ts         # 주문 API
│   │   │   ├── cart.ts           # 장바구니 API
│   │   │   ├── streaming.ts      # 스트리밍 API
│   │   │   ├── auth.ts           # 인증 API
│   │   │   └── admin.ts          # 관리자 API
│   │   │
│   │   ├── hooks/                # 커스텀 React 훅
│   │   │   └── use-stream-viewer.ts
│   │   │
│   │   ├── contexts/             # React Context
│   │   │   └── CartContext.tsx
│   │   │
│   │   ├── providers/            # Provider 컴포넌트
│   │   │   └── query-provider.tsx # TanStack Query
│   │   │
│   │   └── theme/
│   │       └── theme-context.tsx # 테마 Context
│   │
│   └── hooks/                    # 추가 커스텀 훅
│       └── useOrientation.ts     # 화면 방향 감지
│
├── public/                       # 정적 파일
├── tailwind.config.ts            # Tailwind 설정
├── postcss.config.js             # PostCSS 설정
├── next.config.ts                # Next.js 설정
├── tsconfig.json                 # TypeScript 설정
└── package.json
```

### 주요 페이지 라우트

| 경로 | 설명 | 인증 필요 |
|------|------|----------|
| `/` | 홈페이지 | X |
| `/login` | 카카오 로그인 | X |
| `/live` | 라이브 목록 | X |
| `/live/[streamKey]` | 라이브 시청 | X |
| `/shop` | 상품 목록 | X |
| `/products/[id]` | 상품 상세 | X |
| `/cart` | 장바구니 | O |
| `/checkout` | 결제 | O |
| `/orders` | 주문 내역 | O |
| `/my-page` | 마이페이지 | O |
| `/admin/*` | 관리자 페이지 | O (ADMIN) |

---

## 3. Packages (`packages/`)

모노레포 공유 패키지

```
packages/
└── shared-types/                 # 백엔드/프론트엔드 공유 타입
    ├── src/
    │   ├── index.ts              # 타입 export
    │   └── README.md
    ├── package.json
    └── tsconfig.json
```

**사용 예시:**
```typescript
import { ProductStatus, OrderStatus } from '@live-commerce/shared-types';
```

---

## 4. Infrastructure (`infrastructure/`)

배포 및 인프라 설정

```
infrastructure/
├── docker/
│   ├── docker-compose.yml        # 프로덕션 Docker Compose
│   │
│   └── nginx-rtmp/               # RTMP 스트리밍 서버 ⭐
│       ├── Dockerfile            # nginx-rtmp 이미지
│       ├── nginx.conf            # HTTP/HLS 서버 설정
│       ├── rtmp.conf             # RTMP 수신 및 트랜스코딩
│       └── entrypoint.sh         # 컨테이너 시작 스크립트
│
├── aws-cdk/                      # AWS CDK 인프라 코드
│   ├── bin/
│   │   └── app.ts                # CDK 앱 진입점
│   ├── lib/
│   │   └── streaming-stack.ts    # 스트리밍 인프라 스택
│   └── package.json
│
├── scripts/
│   └── build-and-push-image.sh   # Docker 이미지 빌드/푸시
│
└── README.md                     # 인프라 문서
```

### nginx-rtmp 설정

**RTMP 수신 (rtmp.conf):**
- 포트: 1935
- OBS 스트리밍 URL: `rtmp://localhost:1935/live/{streamKey}`
- 인증 콜백: `POST /api/streaming/auth`
- 종료 콜백: `POST /api/streaming/done`

**HLS 변환:**
- 세그먼트 길이: 2초
- 플레이리스트 길이: 6초
- 다중 비트레이트: 720p, 480p, 360p

---

## 5. Docs (`docs/`)

프로젝트 문서

```
docs/
├── 1. 문서 개요.md
├── 1. 디자인 철학 및 원칙.md
├── 1인 셀러 라이브 커머스 MVP 플랫폼.md
├── 1인 셀러 라이브 커머스 MVP_ 프론트엔드 기술 스택 및 구현 가이드.md
├── 프론트백엔드-작업-분리-가이드.md
├── 코드베이스-구조.md            # 이 문서
│
├── wireframes/                   # Excalidraw 와이어프레임
│   ├── wireframe-live-screen-multi-device-*.excalidraw
│   ├── wireframe-admin-dashboard-*.excalidraw
│   ├── wireframe-cart-reservation-*.excalidraw
│   └── ...
│
├── reference UI/                 # 참고 UI 스크린샷
│   ├── live화면 공지사항 다이얼로그.png
│   ├── live화면 문의하기 다이얼로그.png
│   └── live화면 주문내역 다이얼로그.png
│
└── 카카오 로그인 구현과 마케팅 선택 체크 관련 질문/
```

---

## 6. 기타 설정 파일

```
dorami/
├── .claude/                      # Claude Code 설정
│   ├── settings.local.json
│   └── commands/                 # 커스텀 명령어
│
├── _bmad/                        # BMAD 방법론 설정
│   ├── _config/
│   │   ├── manifest.yaml
│   │   └── agents/
│   └── bmm/
│       └── agents/
│
├── ui frame/                     # UI 디자인 참고
│   ├── home.png
│   ├── live.png
│   ├── add to cart.png
│   ├── limited stock.png
│   └── order complete.png
│
├── docker-compose.yml            # 로컬 개발용 (PostgreSQL, Redis)
├── package.json                  # 루트 모노레포 설정
├── package-lock.json
├── .gitignore
└── README.md
```

---

## 핵심 데이터 흐름

### 라이브 스트리밍 흐름

```
┌─────────────┐    RTMP      ┌──────────────┐    HLS      ┌─────────────┐
│     OBS     │ ──────────►  │  nginx-rtmp  │ ─────────►  │  VideoPlayer │
│  (방송자)    │   :1935      │  (트랜스코딩)  │   :8080     │   (시청자)   │
└─────────────┘              └──────────────┘             └─────────────┘
                                    │
                                    │ on_publish / on_publish_done
                                    ▼
                             ┌──────────────┐
                             │   Backend    │
                             │  (NestJS)    │
                             └──────────────┘
```

### 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client (Browser)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Next.js   │  │   HLS.js    │  │      Socket.IO          │  │
│  │   (React)   │  │  (Video)    │  │   (Chat/Realtime)       │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
└─────────┼────────────────┼─────────────────────┼────────────────┘
          │ HTTP           │ HLS                 │ WebSocket
          ▼                ▼                     ▼
┌─────────────────┐  ┌───────────────┐  ┌─────────────────┐
│    Backend      │  │  nginx-rtmp   │  │    Backend      │
│    (NestJS)     │  │  (HLS CDN)    │  │   (Socket.IO)   │
│    :3001        │  │    :8080      │  │     :3001       │
└────────┬────────┘  └───────────────┘  └────────┬────────┘
         │                                       │
         │           ┌───────────────┐           │
         └──────────►│     Redis     │◄──────────┘
                     │  (Cache/PubSub)│
                     └───────────────┘
                            │
                     ┌──────┴──────┐
                     ▼             ▼
              ┌───────────┐ ┌───────────┐
              │ PostgreSQL│ │   Redis   │
              │   (Data)  │ │ (Session) │
              └───────────┘ └───────────┘
```

---

## 개발 환경 설정

### 필수 요구사항

- Node.js 20+
- npm 10+
- Docker Desktop
- PostgreSQL 15+
- Redis 7+

### 로컬 개발 시작

```bash
# 1. 의존성 설치
npm install

# 2. 환경변수 설정
cp backend/.env.example backend/.env

# 3. Docker 컨테이너 실행 (DB, Redis)
docker compose up -d

# 4. Prisma 클라이언트 생성
cd backend && npx prisma generate

# 5. DB 마이그레이션
npx prisma migrate dev

# 6. 개발 서버 실행
npm run dev:all
```

### 접속 URL

| 서비스 | URL |
|--------|-----|
| 프론트엔드 | http://localhost:3000 |
| 백엔드 API | http://localhost:3001/api |
| HLS 스트리밍 | http://localhost:8080/hls |
| RTMP 서버 | rtmp://localhost:1935/live |

---

## npm 스크립트

```bash
# 개발
npm run dev:all          # 프론트엔드 + 백엔드 동시 실행
npm run dev:client       # 프론트엔드만 실행
npm run dev:backend      # 백엔드만 실행

# 빌드
npm run build:all        # 전체 빌드
npm run build:client     # 프론트엔드 빌드
npm run build:backend    # 백엔드 빌드
npm run build:shared     # 공유 타입 빌드

# 테스트
npm run test:backend     # 백엔드 유닛 테스트
npm run test:e2e         # E2E 테스트

# 타입 체크
npm run type-check:all   # 전체 타입 체크

# Prisma
npm run prisma:generate  # Prisma 클라이언트 생성
npm run prisma:migrate   # DB 마이그레이션
npm run prisma:studio    # Prisma Studio 실행

# Docker
npm run docker:up        # Docker 컨테이너 시작
npm run docker:down      # Docker 컨테이너 중지
```

---

*마지막 업데이트: 2026-02-03*
