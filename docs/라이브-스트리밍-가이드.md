# 라이브 스트리밍 시스템 가이드

## 1. 지연 시간 (Latency)

### 예상 총 지연: **5~8초**

| 구성 요소 | 설정값 | 지연 기여 |
|----------|--------|----------|
| HLS 세그먼트 길이 | 2초 | ~2초 |
| HLS 플레이리스트 | 6초 (3개 세그먼트) | ~3초 |
| HLS.js liveSyncDuration | 3초 | ~3초 |
| 네트워크/버퍼링 | - | ~1-2초 |

### 지연 설정 위치

**nginx-rtmp (서버 측)** - `infrastructure/docker/nginx-rtmp/rtmp.conf`
```nginx
hls_fragment 2s;         # 세그먼트 길이 (줄이면 지연 감소, 안정성 감소)
hls_playlist_length 6s;  # 플레이리스트 길이 (3개 세그먼트)
```

**HLS.js (클라이언트 측)** - `client-app/src/components/stream/VideoPlayer.tsx`
```typescript
const hls = new Hls({
  lowLatencyMode: true,
  backBufferLength: 10,
  maxBufferLength: 15,
  liveSyncDuration: 3,        // 라이브 엣지에서 3초 뒤
  liveMaxLatencyDuration: 5,  // 최대 지연 5초
  liveDurationInfinity: true,
});
```

### 지연 시간 조정 방법

| 목표 | 변경 사항 | 트레이드오프 |
|------|----------|-------------|
| **더 낮은 지연 (3-5초)** | `hls_fragment 1s`, `liveSyncDuration: 2` | 버퍼링 증가, 불안정 |
| **더 안정적 (8-12초)** | `hls_fragment 4s`, `liveSyncDuration: 5` | 지연 증가 |

---

## 2. 시스템 아키텍처

```
┌─────────────┐     RTMP      ┌──────────────┐      HLS       ┌─────────────┐
│     OBS     │ ────────────► │  nginx-rtmp  │ ─────────────► │  Browser    │
│  (방송자)    │   :1935       │              │    :8080       │  (시청자)   │
└─────────────┘               └──────┬───────┘               └─────────────┘
                                     │
                    on_publish       │       on_publish_done
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
              ┌──────────────┐                 ┌──────────────┐
              │ POST /auth   │                 │ POST /done   │
              │ (스트림 인증)  │                 │ (스트림 종료)  │
              └──────┬───────┘                 └──────┬───────┘
                     │                                │
                     ▼                                ▼
              ┌─────────────────────────────────────────────┐
              │              Backend (NestJS)                │
              │  - 스트림 키 검증                              │
              │  - DB 상태 업데이트 (PENDING → LIVE → OFFLINE) │
              │  - Redis 시청자 수 관리                        │
              └─────────────────────────────────────────────┘
```

---

## 3. 방송 설정 방법

### Step 1: 스트림 키 발급 (API)

```bash
# 로그인 후 JWT 토큰 필요
POST /api/streaming/generate-key
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "title": "오늘의 라이브 방송"
}
```

**응답:**
```json
{
  "id": "stream-uuid",
  "userId": "user-uuid",
  "streamKey": "abc123def456...",
  "title": "오늘의 라이브 방송",
  "status": "PENDING",
  "rtmpUrl": "rtmp://localhost:1935/live/abc123def456...",
  "hlsUrl": "http://localhost:8080/hls/abc123def456.../index.m3u8",
  "expiresAt": "2026-02-04T16:00:00.000Z",
  "createdAt": "2026-02-03T16:00:00.000Z"
}
```

### Step 2: OBS 설정

1. **OBS Studio** 열기
2. **설정 → 방송** 이동
3. 다음 값 입력:

| 항목 | 값 |
|------|-----|
| 서비스 | 사용자 지정... |
| 서버 | `rtmp://localhost:1935/live` |
| 스트림 키 | API에서 발급받은 `streamKey` |

4. **설정 → 출력** (권장 설정):

| 항목 | 값 |
|------|-----|
| 출력 모드 | 고급 |
| 인코더 | x264 (또는 NVENC) |
| 비트레이트 | 2500 Kbps |
| 키프레임 간격 | 2초 |
| 프로파일 | baseline |

5. **설정 → 비디오**:

| 항목 | 값 |
|------|-----|
| 기본 해상도 | 1280x720 |
| 출력 해상도 | 1280x720 |
| FPS | 30 |

### Step 3: 방송 시작

1. OBS에서 **방송 시작** 클릭
2. nginx-rtmp가 `POST /api/streaming/auth` 호출
3. 백엔드가 스트림 키 검증 → 200 OK 반환
4. 스트림 상태가 `PENDING` → `LIVE`로 변경
5. 시청자가 `/live/{streamKey}` 페이지에서 시청 가능

### Step 4: 방송 종료

1. OBS에서 **방송 중단** 클릭
2. nginx-rtmp가 `POST /api/streaming/done` 호출
3. 스트림 상태가 `LIVE` → `OFFLINE`으로 변경
4. 총 방송 시간 기록

---

## 4. API 엔드포인트 목록

### 공개 API (인증 불필요)

| Method | Endpoint | 설명 | 프론트엔드 연동 |
|--------|----------|------|----------------|
| `GET` | `/streaming/active` | 현재 라이브 중인 스트림 목록 | ✅ `streaming.ts` |
| `GET` | `/streaming/upcoming` | 예정된 스트림 목록 | ✅ `streaming.ts` |
| `GET` | `/streaming/key/:streamKey/status` | 스트림 키로 상태 조회 | ✅ `[streamKey]/page.tsx` |
| `GET` | `/streaming/:id/status` | 스트림 ID로 상태 조회 | ✅ |
| `POST` | `/streaming/auth` | nginx-rtmp 인증 콜백 | ✅ (nginx-rtmp) |
| `POST` | `/streaming/done` | nginx-rtmp 종료 콜백 | ✅ (nginx-rtmp) |

### 인증 필요 API

| Method | Endpoint | 설명 | 프론트엔드 연동 |
|--------|----------|------|----------------|
| `POST` | `/streaming/generate-key` | 스트림 키 발급 | ⚠️ 미연동 (관리자 UI 없음) |
| `POST` | `/streaming/start` | 스트림 세션 생성 | ⚠️ 미연동 |
| `PATCH` | `/streaming/:id/go-live` | 수동으로 LIVE 상태 변경 | ⚠️ 미연동 |
| `PATCH` | `/streaming/:id/stop` | 수동으로 스트림 종료 | ⚠️ 미연동 |

### 관리자 전용 API

| Method | Endpoint | 설명 | 프론트엔드 연동 |
|--------|----------|------|----------------|
| `GET` | `/streaming/history` | 방송 기록 조회 | ✅ `broadcasts/page.tsx` |
| `GET` | `/streaming/live-status` | 현재 라이브 상태 | ✅ `broadcasts/page.tsx` |

---

## 5. 프론트엔드-백엔드 바인딩 리뷰

### ✅ 연동 완료

| 기능 | 프론트엔드 | 백엔드 | 상태 |
|------|-----------|--------|------|
| 라이브 시청 페이지 | `/live/[streamKey]/page.tsx` | `GET /streaming/key/:streamKey/status` | ✅ |
| HLS 비디오 재생 | `VideoPlayer.tsx` (HLS.js) | nginx-rtmp HLS | ✅ |
| 실시간 시청자 수 | `VideoPlayer.tsx` (Socket.IO) | `StreamingGateway` | ✅ |
| 방송 기록 (관리자) | `/admin/broadcasts/page.tsx` | `GET /streaming/history` | ✅ |
| 라이브 상태 (관리자) | `/admin/broadcasts/page.tsx` | `GET /streaming/live-status` | ✅ |
| 예정된 방송 목록 | `streaming.ts` | `GET /streaming/upcoming` | ✅ |
| 활성 방송 목록 | `streaming.ts` | `GET /streaming/active` | ✅ |
| RTMP 인증 | nginx-rtmp | `POST /streaming/auth` | ✅ |
| RTMP 종료 | nginx-rtmp | `POST /streaming/done` | ✅ |

### ⚠️ 미연동 (UI 없음)

| 기능 | 백엔드 API | 필요한 UI |
|------|-----------|----------|
| 스트림 키 발급 | `POST /streaming/generate-key` | 관리자 방송 설정 페이지 |
| 스트림 시작 | `POST /streaming/start` | (OBS 연동으로 대체됨) |
| 수동 LIVE 전환 | `PATCH /streaming/:id/go-live` | (OBS 연동으로 대체됨) |
| 수동 스트림 종료 | `PATCH /streaming/:id/stop` | 관리자 방송 관리 페이지 |

---

## 6. WebSocket 이벤트

### 클라이언트 → 서버

| 이벤트 | 페이로드 | 설명 |
|--------|---------|------|
| `stream:viewer:join` | `{ streamKey }` | 시청 시작 |
| `stream:viewer:leave` | `{ streamKey }` | 시청 종료 |

### 서버 → 클라이언트

| 이벤트 | 페이로드 | 설명 |
|--------|---------|------|
| `connection:success` | `{ userId, timestamp }` | 연결 성공 |
| `stream:viewer-count` | `{ streamKey, viewerCount }` | 시청자 수 업데이트 |
| `stream:ended` | `{ streamKey }` | 방송 종료 알림 |
| `error` | `{ errorCode, message }` | 에러 |

### 연결 정보

```typescript
// 클라이언트 연결
const socket = io('http://localhost:3001/streaming', {
  transports: ['websocket'],
  withCredentials: true,
});
```

---

## 7. 인프라 구성

### Docker Compose 실행

```bash
# 전체 인프라 실행 (PostgreSQL, Redis, nginx-rtmp)
cd infrastructure/docker
docker compose up -d
```

### 포트 정보

| 서비스 | 포트 | 설명 |
|--------|------|------|
| nginx-rtmp (RTMP) | 1935 | OBS 스트리밍 수신 |
| nginx-rtmp (HLS) | 8080 | HLS 스트리밍 제공 |
| Backend | 3001 | API 서버 |
| Frontend | 3000 | Next.js 서버 |
| PostgreSQL | 5432 | 데이터베이스 |
| Redis | 6379 | 캐시/세션/Pub-Sub |

### 환경 변수 (backend/.env)

```bash
# 스트리밍 관련
RTMP_SERVER_URL=rtmp://localhost:1935/live
HLS_SERVER_URL=http://localhost:8080/hls
```

---

## 8. 다중 비트레이트 (ABR)

nginx-rtmp는 FFmpeg로 다중 비트레이트 스트림을 생성합니다.

| 품질 | 해상도 | 비트레이트 |
|------|--------|-----------|
| 720p | 1280x720 | 2500 Kbps |
| 480p | 854x480 | 1000 Kbps |
| 360p | 640x360 | 500 Kbps |

HLS.js는 네트워크 상태에 따라 자동으로 품질을 전환합니다.

---

## 9. 개선 필요 사항

### 높은 우선순위

1. **스트림 키 발급 UI**
   - 관리자 페이지에 "방송 시작" 버튼 추가
   - `POST /streaming/generate-key` 호출
   - OBS 설정 정보 표시 (RTMP URL, 스트림 키)

2. **방송 종료 버튼**
   - 관리자 페이지에서 수동 종료 기능
   - `PATCH /streaming/:id/stop` 호출

### 중간 우선순위

3. **썸네일 생성**
   - FFmpeg로 주기적 스크린샷 생성
   - 스트림 목록에 썸네일 표시

4. **방송 예약 기능**
   - 예약 시간 설정 UI
   - 예약 알림 발송

### 낮은 우선순위

5. **다시보기 (VOD)**
   - 방송 녹화 저장
   - VOD 재생 페이지

6. **LL-HLS (초저지연)**
   - Apple LL-HLS 지원
   - 2-3초 지연 달성

---

## 10. 테스트 방법

### 로컬 테스트 (Docker 없이)

```bash
# 1. 백엔드 실행
npm run dev:backend

# 2. 프론트엔드 실행
npm run dev:client

# 3. 스트림 키 발급 (API 직접 호출)
curl -X POST http://localhost:3001/api/streaming/generate-key \
  -H "Authorization: Bearer {JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"title": "테스트 방송"}'

# 4. OBS 설정 후 방송 시작
# (nginx-rtmp 없이는 HLS 재생 불가)
```

### 전체 테스트 (Docker 포함)

```bash
# 1. 인프라 실행
docker compose up -d

# 2. 백엔드/프론트엔드 실행
npm run dev:all

# 3. 스트림 키 발급

# 4. OBS 설정
#    서버: rtmp://localhost:1935/live
#    키: {발급받은 스트림 키}

# 5. OBS 방송 시작

# 6. 브라우저에서 시청
#    http://localhost:3000/live/{streamKey}
```

---

*마지막 업데이트: 2026-02-03*
