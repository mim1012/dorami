# Staging Deployment Workflow
# Automatically deploys to staging when code is pushed to develop branch
# Can also be triggered manually

name: Deploy to Staging

on:
  push:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: staging-deployment
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/dorami

jobs:
  # ===========================================
  # Run CI Tests First
  # ===========================================
  test:
    name: Run Tests
    if: ${{ github.event_name == 'workflow_dispatch' && !inputs.skip_tests }}
    uses: ./.github/workflows/ci.yml

  # ===========================================
  # Build and Push Docker Images (unified)
  # ===========================================
  build:
    name: Build Images
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: ./.github/workflows/build-images.yml
    permissions:
      contents: read
      packages: write

  # ===========================================
  # Deploy to Staging Server
  # ===========================================
  deploy:
    name: Deploy to Staging
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          HOST: ${{ secrets.STAGING_HOST }}
          USER: ${{ secrets.STAGING_USER }}
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh $USER@$HOST << ENDSSH
            set -e

            cd /opt/dorami

            echo "=== Pulling latest code ==="
            git fetch origin ${{ github.ref_name }}
            git reset --hard origin/${{ github.ref_name }}

            echo "=== Cleaning up old images ==="
            docker image prune -af --filter "until=24h" || true
            docker builder prune -af --filter "until=24h" || true
            echo "Disk usage after cleanup:"
            df -h / | tail -1

            echo "=== Logging into GHCR ==="
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u ${GITHUB_REPOSITORY_OWNER} --password-stdin

            echo "=== Pulling new images ==="
            export IMAGE_TAG=${IMAGE_TAG}
            export GITHUB_REPOSITORY_OWNER=${GITHUB_REPOSITORY_OWNER}
            export STAGING_HOST=${HOST}
            docker compose -f docker-compose.staging.yml pull

            echo "=== Running database migrations ==="
            docker compose -f docker-compose.staging.yml run --rm -T backend npx prisma migrate deploy < /dev/null

            echo "=== Restarting services ==="
            docker compose -f docker-compose.staging.yml up -d --force-recreate --remove-orphans

            echo "=== Cleaning up old images ==="
            docker image prune -af --filter "until=1h"

            echo "=== Checking service health ==="
            for i in 1 2 3 4 5 6; do
              if curl -sf http://localhost:3001/api/v1/health > /dev/null 2>&1; then
                echo "Backend healthy!"
                break
              fi
              if [ "\$i" = "6" ]; then
                echo "Backend health check failed after 6 attempts"
                docker compose -f docker-compose.staging.yml logs backend --tail=50
                exit 1
              fi
              echo "Waiting for backend... (attempt \$i/6)"
              sleep 15
            done

            for i in 1 2 3 4 5 6; do
              if curl -sf http://localhost:3000 > /dev/null 2>&1; then
                echo "Frontend healthy!"
                break
              fi
              if [ "\$i" = "6" ]; then
                echo "Frontend health check failed after 6 attempts"
                docker compose -f docker-compose.staging.yml logs frontend --tail=50
                exit 1
              fi
              echo "Waiting for frontend... (attempt \$i/6)"
              sleep 10
            done

            echo "=== Deployment complete ==="
          ENDSSH

      - name: Notify Success
        if: success()
        run: |
          echo "Staging deployment successful!"
          echo "Image tag: ${{ needs.build.outputs.image_tag }}"
          echo "URL: ${{ secrets.STAGING_URL }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Staging deployment failed!"
          exit 1

  # ===========================================
  # Post-deployment Smoke Tests (via SSH)
  # ===========================================
  smoke-test:
    name: Smoke Tests
    needs: [deploy]
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Health Check - Backend
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            'curl -sf -o /dev/null -w "%{http_code}" http://localhost:3001/api/v1/health'
          echo "Backend health check passed"

      - name: Health Check - Frontend
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            'curl -sf -o /dev/null -w "%{http_code}" http://localhost:3000'
          echo "Frontend health check passed"

      - name: API Response Test
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            'curl -s http://localhost:3001/api/v1/health'
