name: Production Maintenance

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Maintenance command to run'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - diagnose
          - fix-ssl
          - fix-ports
          - logs-backend
          - logs-frontend
          - logs-proxy
          - db-check
          - db-restore
          - find-data
          - restart-backend
          - restart-frontend
          - restart-all

jobs:
  run:
    name: Run Maintenance Command
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
          HOST: ${{ secrets.PRODUCTION_HOST }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null && echo "SSH key OK" || { echo "SSH key invalid"; exit 1; }

      - name: status
        if: inputs.command == 'status'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== 컨테이너 상태 ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo "=== 디스크 ==="
          df -h / && docker system df
          EOF

      - name: logs-backend
        if: inputs.command == 'logs-backend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker logs dorami-backend-prod --tail=200 2>&1'

      - name: logs-frontend
        if: inputs.command == 'logs-frontend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker logs dorami-frontend-prod --tail=200 2>&1'

      - name: logs-proxy
        if: inputs.command == 'logs-proxy'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker logs dorami-proxy-prod --tail=200 2>&1'

      - name: db-check
        if: inputs.command == 'db-check'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== 백업 파일 ==="
          ls -lah /opt/dorami/backups/ 2>/dev/null || echo "(없음)"
          echo "=== users ==="
          docker exec dorami-postgres-prod bash -c 'PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d $POSTGRES_DB -t -c "SELECT COUNT(*) FROM users;"' 2>&1 || echo "fail"
          echo "=== products ==="
          docker exec dorami-postgres-prod bash -c 'PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d $POSTGRES_DB -t -c "SELECT COUNT(*) FROM products;"' 2>&1 || echo "fail"
          echo "=== live_streams ==="
          docker exec dorami-postgres-prod bash -c 'PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d $POSTGRES_DB -t -c "SELECT COUNT(*) FROM live_streams;"' 2>&1 || echo "fail"
          echo "=== orders ==="
          docker exec dorami-postgres-prod bash -c 'PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d $POSTGRES_DB -t -c "SELECT COUNT(*) FROM orders;"' 2>&1 || echo "fail"
          EOF

      - name: db-restore
        if: inputs.command == 'db-restore'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          set -euo pipefail
          LATEST=$(ls -t /opt/dorami/backups/db_backup_*.sql.gz 2>/dev/null | head -1)
          if [ -z "$LATEST" ]; then
            echo "ERROR: 백업 없음"
            exit 1
          fi
          echo "복구: $LATEST"
          PGUSER=$(docker exec dorami-postgres-prod env | grep POSTGRES_USER | cut -d= -f2)
          PGPASS=$(docker exec dorami-postgres-prod env | grep POSTGRES_PASSWORD | cut -d= -f2)
          PGDB=$(docker exec dorami-postgres-prod env | grep POSTGRES_DB | cut -d= -f2)
          zcat "$LATEST" | docker exec -i dorami-postgres-prod bash -c "PGPASSWORD=$PGPASS psql -U $PGUSER -d $PGDB"
          docker restart dorami-backend-prod
          sleep 15
          docker inspect --format='Health: {{.State.Health.Status}}' dorami-backend-prod 2>/dev/null
          echo "완료!"
          EOF

      - name: find-data
        if: inputs.command == 'find-data'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== Docker 볼륨 전체 목록 ==="
          docker volume ls
          echo "=== 삭제된 컨테이너 포함 전체 ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}" 2>&1 | head -30
          echo "=== PG_VERSION 파일 검색 ==="
          find / -name "PG_VERSION" 2>/dev/null | head -10
          echo "=== /opt 디렉토리 구조 ==="
          ls -lah /opt/ 2>/dev/null
          ls -lah /opt/live-commerce/ 2>/dev/null || echo "/opt/live-commerce 없음"
          ls -lah /opt/dorami/ 2>/dev/null || echo "/opt/dorami 없음"
          echo "=== /var/lib/docker/volumes 목록 ==="
          ls -lah /var/lib/docker/volumes/ 2>/dev/null || sudo ls -lah /var/lib/docker/volumes/ 2>/dev/null || echo "접근 불가"
          echo "=== /home/ubuntu 구조 ==="
          ls -lah /home/ubuntu/ 2>/dev/null || echo "(없음)"
          echo "=== live-commerce 관련 docker 볼륨 ==="
          docker volume ls | grep -i "live\|commerce\|postgres\|pg" || echo "관련 볼륨 없음"
          EOF

      - name: diagnose
        if: inputs.command == 'diagnose'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== 포트 바인딩 (ss) ==="
          ss -tlnp | grep -E ':80|:443|:3000|:3001|:8080' || echo "(없음)"
          echo "=== Docker 포트 바인딩 상세 ==="
          docker inspect dorami-frontend-prod --format '포트: {{json .HostConfig.PortBindings}}' 2>/dev/null
          docker inspect dorami-backend-prod --format '포트: {{json .HostConfig.PortBindings}}' 2>/dev/null
          echo "=== PM2 프로세스 ==="
          pm2 list 2>/dev/null || echo "PM2 없음"
          echo "=== Host Nginx 설정 ==="
          cat /etc/nginx/sites-enabled/* 2>/dev/null || cat /etc/nginx/conf.d/*.conf 2>/dev/null || echo "설정 파일 없음"
          echo "=== docker-compose.prod.yml ports 섹션 ==="
          grep -A3 "ports:" /opt/dorami/docker-compose.prod.yml 2>/dev/null || echo "파일 없음"
          EOF

      - name: fix-ports
        if: inputs.command == 'fix-ports'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          set -euo pipefail
          echo "=== PM2 중지 ==="
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          echo "=== 포트 점유 프로세스 종료 ==="
          fuser -k 3000/tcp 2>/dev/null || true
          fuser -k 3001/tcp 2>/dev/null || true
          sleep 2
          echo "=== frontend/backend force-recreate ==="
          cd /opt/dorami
          docker compose -f docker-compose.prod.yml --env-file .env.production \
            up -d --no-deps --force-recreate backend frontend
          echo "=== 결과 ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF

      - name: fix-ssl
        if: inputs.command == 'fix-ssl'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== 호스트 인증서 확인 ==="
          ls /etc/letsencrypt/live/ 2>/dev/null || echo "호스트에 letsencrypt 없음"
          echo "=== certbot_conf 볼륨 내용 ==="
          docker run --rm -v dorami_certbot_conf:/etc/letsencrypt alpine ls /etc/letsencrypt/live/ 2>/dev/null || echo "볼륨 비어있음"
          echo "=== 호스트 → Docker 볼륨 인증서 복사 ==="
          if [ -d /etc/letsencrypt/live/doremi-live.com ]; then
            docker run --rm \
              -v /etc/letsencrypt:/host-letsencrypt:ro \
              -v dorami_certbot_conf:/etc/letsencrypt \
              alpine sh -c "cp -r /host-letsencrypt/live /host-letsencrypt/archive /host-letsencrypt/renewal /etc/letsencrypt/ 2>/dev/null; ls /etc/letsencrypt/live/"
            echo "복사 완료"
          else
            echo "호스트에 doremi-live.com 인증서 없음 — certbot 직접 발급 시도"
            docker stop dorami-proxy-prod 2>/dev/null || true
            docker run --rm \
              -v dorami_certbot_conf:/etc/letsencrypt \
              -v dorami_certbot_www:/var/www/certbot \
              -p 80:80 \
              certbot/certbot certonly --standalone \
              -d doremi-live.com -d www.doremi-live.com \
              --email admin@dorami.shop \
              --agree-tos --no-eff-email --non-interactive 2>&1
          fi
          echo "=== nginx-proxy 재시작 ==="
          cd /opt/dorami
          docker compose -f docker-compose.prod.yml --env-file .env.production \
            up -d --no-deps --force-recreate nginx-proxy
          sleep 5
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "proxy|NAME"
          docker logs dorami-proxy-prod --tail=10 2>&1
          EOF

      - name: restart-backend
        if: inputs.command == 'restart-backend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker restart dorami-backend-prod && echo "완료"'

      - name: restart-frontend
        if: inputs.command == 'restart-frontend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker restart dorami-frontend-prod && echo "완료"'

      - name: restart-all
        if: inputs.command == 'restart-all'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          docker restart dorami-backend-prod dorami-frontend-prod
          docker ps --format "table {{.Names}}\t{{.Status}}"
          EOF
