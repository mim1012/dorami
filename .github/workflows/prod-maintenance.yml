name: Production Maintenance

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Maintenance command to run'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - logs-backend
          - logs-frontend
          - db-check
          - db-restore
          - restart-backend
          - restart-frontend
          - restart-all

jobs:
  run:
    name: Run Maintenance Command
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Add Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: status
        if: inputs.command == 'status'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== 컨테이너 상태 ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== 디스크 사용량 ==="
          df -h / && docker system df
          EOF

      - name: logs-backend
        if: inputs.command == 'logs-backend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker logs dorami-backend-prod --tail=200 2>&1'

      - name: logs-frontend
        if: inputs.command == 'logs-frontend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker logs dorami-frontend-prod --tail=200 2>&1'

      - name: db-check
        if: inputs.command == 'db-check'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          echo "=== dorami_production DB 데이터 개수 ==="
          docker exec dorami-postgres-prod bash -c \
            'PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d dorami_production \
             -c "SELECT COUNT(*) as users FROM \"User\";" \
             -c "SELECT COUNT(*) as products FROM \"Product\";" \
             -c "SELECT COUNT(*) as orders FROM \"Order\";" 2>&1'

          echo ""
          echo "=== 익명 볼륨 a10ab7ef 내용 탐색 (구 live-commerce-postgres 데이터 여부) ==="
          docker run --rm \
            -v a10ab7ef152ddceeed1a2ae5904eddc0358e835fcdaa18398073f3db25d5cc47:/pgdata:ro \
            alpine sh -c 'ls /pgdata/ 2>/dev/null && du -sh /pgdata 2>/dev/null || echo "(볼륨 마운트 실패)"'

          echo ""
          echo "=== 익명 볼륨이 postgres 데이터인지 확인 ==="
          docker run --rm \
            -v a10ab7ef152ddceeed1a2ae5904eddc0358e835fcdaa18398073f3db25d5cc47:/pgdata:ro \
            alpine sh -c 'ls /pgdata/global/ 2>/dev/null && echo "YES: postgres 데이터 디렉토리" || echo "NO: postgres 데이터 아님"'
          EOF

      - name: db-restore
        if: inputs.command == 'db-restore'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          set -euo pipefail

          echo "=== DB 복구 시작 ==="

          if ! docker ps --format '{{.Names}}' | grep -q '^live-commerce-postgres$'; then
            echo "ERROR: live-commerce-postgres 가 실행 중이지 않습니다"
            docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep postgres || true
            exit 1
          fi

          PGUSER=$(docker exec dorami-postgres-prod env | grep POSTGRES_USER | cut -d= -f2)
          PGPASS=$(docker exec dorami-postgres-prod env | grep POSTGRES_PASSWORD | cut -d= -f2)
          PGDB=$(docker exec dorami-postgres-prod env | grep POSTGRES_DB | cut -d= -f2)

          echo "=== 원본 데이터 개수 ==="
          docker exec live-commerce-postgres psql -U postgres -d live_commerce_production \
            -c 'SELECT COUNT(*) as users FROM "User";' \
            -c 'SELECT COUNT(*) as products FROM "Product";' 2>/dev/null

          echo "=== 현재 DB 백업 ==="
          mkdir -p /opt/dorami/backups
          docker exec dorami-postgres-prod bash -c \
            "PGPASSWORD=$PGPASS pg_dump -U $PGUSER $PGDB" \
            | gzip > /opt/dorami/backups/pre-restore-$(date +%Y%m%d_%H%M%S).sql.gz \
            && echo "백업 완료" || echo "백업 실패 (계속 진행)"

          echo "=== 데이터 이전: live_commerce_production -> $PGDB ==="
          docker exec live-commerce-postgres pg_dump \
            -U postgres --no-owner --no-acl --clean --if-exists \
            live_commerce_production \
            | docker exec -i dorami-postgres-prod bash -c "PGPASSWORD=$PGPASS psql -U $PGUSER -d $PGDB"

          echo "=== 복구 후 데이터 개수 ==="
          docker exec dorami-postgres-prod bash -c \
            "PGPASSWORD=$PGPASS psql -U $PGUSER -d $PGDB \
             -c 'SELECT COUNT(*) as users FROM \"User\";' \
             -c 'SELECT COUNT(*) as products FROM \"Product\";' \
             -c 'SELECT COUNT(*) as orders FROM \"Order\";'" 2>/dev/null

          echo "=== 백엔드 재시작 ==="
          docker restart dorami-backend-prod
          sleep 15
          docker inspect --format='Health: {{.State.Health.Status}}' dorami-backend-prod 2>/dev/null || true
          echo "DB 복구 완료!"
          EOF

      - name: restart-backend
        if: inputs.command == 'restart-backend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker restart dorami-backend-prod && echo "백엔드 재시작 완료"'

      - name: restart-frontend
        if: inputs.command == 'restart-frontend'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: ssh $USER@$HOST 'docker restart dorami-frontend-prod && echo "프론트엔드 재시작 완료"'

      - name: restart-all
        if: inputs.command == 'restart-all'
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST bash << 'EOF'
          docker restart dorami-backend-prod dorami-frontend-prod
          echo "재시작 완료"
          docker ps --format "table {{.Names}}\t{{.Status}}"
          EOF
