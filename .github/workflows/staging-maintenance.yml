name: Staging Maintenance

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Maintenance command to run'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - logs-backend
          - logs-frontend
          - logs-srs
          - load-test-live
          - restart
          - restart-backend
          - restart-frontend
          - db-migrate
          - disk-usage
          - docker-cleanup
      stream_key:
        description: 'Optional stream key for load-test-live (blank=auto active stream)'
        required: false
        default: ''
        type: string
      concurrency:
        description: 'Concurrency for load-test-live'
        required: false
        default: '30'
        type: string
      duration_seconds:
        description: 'Duration seconds for load-test-live'
        required: false
        default: '60'
        type: string

jobs:
  run:
    name: Run Maintenance Command
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          mkdir -p ~/.ssh
          KEY_OK=false
          printf '%s\n' "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "SSH key loaded (raw PEM)"
            KEY_OK=true
          fi
          if [ "$KEY_OK" = "false" ]; then
            if printf '%s' "$SSH_KEY" | tr -d ' \r\n' | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
              chmod 600 ~/.ssh/id_rsa
              if ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
                echo "SSH key loaded (base64)"
                KEY_OK=true
              fi
            fi
          fi
          if [ "$KEY_OK" = "false" ]; then
            echo "ERROR: SSH key invalid. len=${#SSH_KEY} has_begin=$(printf '%s' "$SSH_KEY" | grep -c BEGIN || echo 0)"
            exit 1
          fi
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Execute Whitelisted Command
        env:
          HOST: ${{ secrets.STAGING_HOST }}
          USER: ${{ secrets.STAGING_USER }}
          COMMAND: ${{ inputs.command }}
          STREAM_KEY_INPUT: ${{ inputs.stream_key }}
          CONCURRENCY: ${{ inputs.concurrency }}
          DURATION_SECONDS: ${{ inputs.duration_seconds }}
        run: |
          case "$COMMAND" in
            status)
              CMD="docker compose -f docker-compose.staging.yml ps"
              ;;
            logs-backend)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 backend"
              ;;
            logs-frontend)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 frontend"
              ;;
            logs-srs)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 srs"
              ;;
            load-test-live)
              CMD="__RUN_LOAD_TEST_LIVE__"
              ;;
            restart)
              CMD="docker compose -f docker-compose.staging.yml restart"
              ;;
            restart-backend)
              CMD="docker compose -f docker-compose.staging.yml restart backend"
              ;;
            restart-frontend)
              CMD="docker compose -f docker-compose.staging.yml restart frontend"
              ;;
            db-migrate)
              CMD="docker compose -f docker-compose.staging.yml exec -T postgres psql -U dorami -d live_commerce -c 'ALTER TABLE orders ADD COLUMN IF NOT EXISTS tracking_number TEXT;'"
              ;;
            disk-usage)
              CMD="df -h / && docker system df"
              ;;
            docker-cleanup)
              CMD="docker system prune -af --volumes --filter 'until=24h' && docker builder prune -af"
              ;;
            *)
              echo "Unknown command: $COMMAND"
              exit 1
              ;;
          esac

          if [ "$CMD" = "__RUN_LOAD_TEST_LIVE__" ]; then
            echo "Executing live load test in staging (concurrency=${CONCURRENCY}, duration=${DURATION_SECONDS}s)"
            ssh $USER@$HOST "bash -s -- \"$STREAM_KEY_INPUT\" \"$CONCURRENCY\" \"$DURATION_SECONDS\"" <<'ENDSSH'
              set -euo pipefail
              cd /opt/dorami

              STREAM_KEY="${1:-}"
              CONC="${2:-30}"
              DUR="${3:-60}"

              if [ -z "$STREAM_KEY" ]; then
                ACTIVE_JSON="$(curl -s http://localhost:3001/api/streaming/active)"
                STREAM_KEY="$(printf '%s' "$ACTIVE_JSON" | sed -n 's/.*"streamKey":"\([^"]*\)".*/\1/p')"
              fi

              if [ -z "$STREAM_KEY" ]; then
                echo "No active stream key found from /api/streaming/active. Aborting."
                exit 1
              fi

              echo "Using stream key: $STREAM_KEY"
              echo "Load target: http://localhost:8080/hls/${STREAM_KEY}.m3u8"
              echo "Start load test: concurrency=${CONC}, duration=${DUR}s"

              TMP_CODES="$(mktemp)"
              START_TS="$(date +%s)"

              while [ $(( $(date +%s) - START_TS )) -lt "$DUR" ]; do
                seq 1 "$CONC" | xargs -P "$CONC" -I{} sh -c \
                  'curl -m 5 -s -o /dev/null -w "%{http_code}\n" "http://localhost:8080/hls/'"$STREAM_KEY"'.m3u8" || echo "000"' \
                  >> "$TMP_CODES"
                sleep 1
              done

              TOTAL="$(wc -l < "$TMP_CODES" | tr -d ' ')"
              OK_200="$(grep -c '^200$' "$TMP_CODES" || true)"
              ERR_404="$(grep -c '^404$' "$TMP_CODES" || true)"
              ERR_5XX="$(grep -E -c '^5[0-9][0-9]$' "$TMP_CODES" || true)"
              ERR_000="$(grep -c '^000$' "$TMP_CODES" || true)"

              echo "=== Load Test Summary ==="
              echo "total=${TOTAL} ok_200=${OK_200} err_404=${ERR_404} err_5xx=${ERR_5XX} err_timeout_or_conn=${ERR_000}"
              echo "status_distribution:"
              sort "$TMP_CODES" | uniq -c | sort -nr

              echo "=== Container Stats Snapshot ==="
              docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | \
                grep -E 'dorami-(backend|frontend|nginx|postgres|redis|srs)' || true

              rm -f "$TMP_CODES"
          ENDSSH
          else
            echo "Executing: $CMD"
            ssh $USER@$HOST "cd /opt/dorami && $CMD"
          fi
