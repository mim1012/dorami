name: Staging Maintenance

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Maintenance command to run'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - logs-backend
          - logs-frontend
          - logs-srs
          - restart
          - restart-backend
          - restart-frontend
          - db-migrate
          - disk-usage
          - docker-cleanup

jobs:
  run:
    name: Run Maintenance Command
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          mkdir -p ~/.ssh
          KEY_OK=false
          printf '%s\n' "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "SSH key loaded (raw PEM)"
            KEY_OK=true
          fi
          if [ "$KEY_OK" = "false" ]; then
            if printf '%s' "$SSH_KEY" | tr -d ' \r\n' | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
              chmod 600 ~/.ssh/id_rsa
              if ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
                echo "SSH key loaded (base64)"
                KEY_OK=true
              fi
            fi
          fi
          if [ "$KEY_OK" = "false" ]; then
            echo "ERROR: SSH key invalid. len=${#SSH_KEY} has_begin=$(printf '%s' "$SSH_KEY" | grep -c BEGIN || echo 0)"
            exit 1
          fi
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Execute Whitelisted Command
        env:
          HOST: ${{ secrets.STAGING_HOST }}
          USER: ${{ secrets.STAGING_USER }}
          COMMAND: ${{ inputs.command }}
        run: |
          case "$COMMAND" in
            status)
              CMD="docker compose -f docker-compose.staging.yml ps"
              ;;
            logs-backend)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 backend"
              ;;
            logs-frontend)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 frontend"
              ;;
            logs-srs)
              CMD="docker compose -f docker-compose.staging.yml logs --tail=200 srs"
              ;;
            restart)
              CMD="docker compose -f docker-compose.staging.yml restart"
              ;;
            restart-backend)
              CMD="docker compose -f docker-compose.staging.yml restart backend"
              ;;
            restart-frontend)
              CMD="docker compose -f docker-compose.staging.yml restart frontend"
              ;;
            db-migrate)
              CMD="docker compose -f docker-compose.staging.yml exec -T postgres psql -U dorami -d live_commerce -c 'ALTER TABLE orders ADD COLUMN IF NOT EXISTS tracking_number TEXT;'"
              ;;
            disk-usage)
              CMD="df -h / && docker system df"
              ;;
            docker-cleanup)
              CMD="docker system prune -af --volumes --filter 'until=24h' && docker builder prune -af"
              ;;
            *)
              echo "Unknown command: $COMMAND"
              exit 1
              ;;
          esac

          echo "Executing: $CMD"
          ssh $USER@$HOST "cd /opt/dorami && $CMD"
