# Auto Deploy to Production
# Triggered on every push to main branch
# Flow: CI tests → Build images → Deploy to production server
#
# Required GitHub Secrets (Settings → Secrets → Actions):
#   PRODUCTION_SSH_KEY  - SSH private key (contents of dorami-prod-key.pem)
#   PRODUCTION_HOST     - Server IP (e.g. 15.165.66.23)
#   PRODUCTION_USER     - SSH user (e.g. ubuntu)

name: Auto Deploy to Production

on:
  push:
    branches: [main]

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  # ===========================================
  # 1. CI Tests
  # ===========================================
  ci:
    name: CI Tests
    uses: ./.github/workflows/ci.yml

  # ===========================================
  # 2. Build & Push Docker Images to GHCR
  # ===========================================
  build:
    name: Build Images
    needs: [ci]
    uses: ./.github/workflows/build-images.yml
    permissions:
      contents: read
      packages: write

  # ===========================================
  # 3. Deploy to Production Server
  # ===========================================
  deploy:
    name: Deploy to Production
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.doremi-live.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Sync compose & infra files to server
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST 'mkdir -p /opt/dorami/infrastructure/docker'
          scp docker-compose.prod.yml $USER@$HOST:/opt/dorami/docker-compose.prod.yml
          scp -r infrastructure/docker/srs $USER@$HOST:/opt/dorami/infrastructure/docker/

      - name: Pull images and restart services
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          REPO_OWNER: ${{ github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh $USER@$HOST bash << ENDSSH
          set -euo pipefail
          cd /opt/dorami

          echo "========================================"
          echo "Deploying image: ${IMAGE_TAG}"
          echo "========================================"

          # Update image tag in .env.production
          sed -i "s|^IMAGE_TAG=.*|IMAGE_TAG=${IMAGE_TAG}|" .env.production \
            || echo "IMAGE_TAG=${IMAGE_TAG}" >> .env.production
          sed -i "s|^GITHUB_REPOSITORY_OWNER=.*|GITHUB_REPOSITORY_OWNER=${REPO_OWNER}|" .env.production \
            || echo "GITHUB_REPOSITORY_OWNER=${REPO_OWNER}" >> .env.production

          # Login to GHCR
          echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${REPO_OWNER}" --password-stdin

          # Pull new images
          echo "=== Pulling images ==="
          docker compose -f docker-compose.prod.yml --env-file .env.production pull backend frontend

          # Restart backend and frontend (backend runs prisma migrate on startup)
          echo "=== Restarting backend ==="
          docker compose -f docker-compose.prod.yml --env-file .env.production \
            up -d --no-deps --force-recreate backend

          # Wait for backend to be healthy
          echo "=== Waiting for backend health ==="
          for i in \$(seq 1 18); do
            status=\$(docker inspect --format='{{.State.Health.Status}}' dorami-backend-prod 2>/dev/null || echo unknown)
            if [ "\$status" = "healthy" ]; then
              echo "Backend healthy!"
              break
            fi
            if [ "\$i" = "18" ]; then
              echo "ERROR: Backend not healthy after 3 minutes"
              docker logs dorami-backend-prod --tail 40
              exit 1
            fi
            echo "  waiting... \$i/18 (status: \$status)"
            sleep 10
          done

          echo "=== Restarting frontend ==="
          docker compose -f docker-compose.prod.yml --env-file .env.production \
            up -d --no-deps --force-recreate frontend

          echo "=== Final status ==="
          docker compose -f docker-compose.prod.yml ps

          echo "========================================"
          echo "Deployment complete!"
          echo "========================================"
          ENDSSH

      - name: Verify - Backend API health
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh $USER@$HOST \
            'curl -sf http://127.0.0.1:3001/api/health/live && echo "Backend API OK" || (echo "Backend API failed"; exit 1)'

      - name: Verify - Public site
        run: |
          curl -sf -o /dev/null -w "HTTP %{http_code}" https://www.doremi-live.com \
            && echo " — Site OK" || echo " — Site check failed (non-fatal)"
