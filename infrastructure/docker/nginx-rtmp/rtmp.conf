# RTMP module configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        ping 30s;
        ping_timeout 10s;
        max_connections 1000;

        # Live application for OBS streaming
        application live {
            live on;
            record off;

            # Authentication callbacks to backend
            # Backend validates stream key before allowing publish
            on_publish http://backend:3001/api/streaming/auth;
            on_publish_done http://backend:3001/api/streaming/done;

            # Drop idle publisher after 10 seconds
            drop_idle_publisher 10s;

            # Allow publishing from anywhere (OBS)
            allow publish all;

            # Allow playing from anywhere
            allow play all;

            # HLS settings for Low-Latency streaming
            hls on;
            hls_path /tmp/hls;
            hls_fragment 1s;        # 1-second segments for lower latency
            hls_playlist_length 3s;  # Keep only 3 segments (3 * 1s = 3s)
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;          # Create subdirectory per stream key

            # HLS variant streams (multi-bitrate)
            hls_variant _720p BANDWIDTH=2500000,RESOLUTION=1280x720;
            hls_variant _480p BANDWIDTH=1000000,RESOLUTION=854x480;
            hls_variant _360p BANDWIDTH=500000,RESOLUTION=640x360;

            # FFmpeg transcoding command
            # Converts incoming RTMP to multiple HLS variants
            exec ffmpeg -i rtmp://localhost/live/$name
                # 720p variant
                -c:v libx264 -preset veryfast -tune zerolatency
                -profile:v baseline -level 3.1
                -b:v 2500k -maxrate 2500k -bufsize 5000k
                -s 1280x720 -r 30 -g 60 -keyint_min 60 -sc_threshold 0
                -c:a aac -b:a 128k -ar 44100
                -f flv rtmp://localhost/hls/$name_720p

                # 480p variant
                -c:v libx264 -preset veryfast -tune zerolatency
                -profile:v baseline -level 3.0
                -b:v 1000k -maxrate 1000k -bufsize 2000k
                -s 854x480 -r 30 -g 60 -keyint_min 60 -sc_threshold 0
                -c:a aac -b:a 96k -ar 44100
                -f flv rtmp://localhost/hls/$name_480p

                # 360p variant
                -c:v libx264 -preset veryfast -tune zerolatency
                -profile:v baseline -level 3.0
                -b:v 500k -maxrate 500k -bufsize 1000k
                -s 640x360 -r 30 -g 60 -keyint_min 60 -sc_threshold 0
                -c:a aac -b:a 64k -ar 44100
                -f flv rtmp://localhost/hls/$name_360p;
        }

        # HLS application for transcoded streams
        application hls {
            live on;
            record off;

            hls on;
            hls_path /tmp/hls;
            hls_fragment 1s;
            hls_playlist_length 3s;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;
        }
    }
}
