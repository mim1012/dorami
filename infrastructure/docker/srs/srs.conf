listen              1935;
max_connections     5000;
daemon              off;
srs_log_tank        console;
srs_log_level       warn;

# Worker threads for multi-core utilization
threads             2;

http_server {
    enabled         on;
    listen          8080;
    crossdomain     on;
}

http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# Heartbeat for monitoring (reports to backend every 9.9s)
heartbeat {
    enabled         on;
    interval        9.9;
    url             http://backend:3001/api/v1/streaming/srs-heartbeat;
}

stats {
    network         0;
}

vhost __defaultVhost__ {
    # Inbound limits: reject abnormal publishers
    publish {
        mr          off;
        firstpkt_timeout    10000;
        normal_timeout      30000;
    }

    # Outbound: client-side play settings
    play {
        gop_cache           on;
        gop_cache_max_frames 2500;
        queue_length        5;
        mw_latency          100;
    }

    # HTTP-FLV remux (primary low-latency output)
    http_remux {
        enabled     on;
        mount       [vhost]/live/[app]/[stream].flv;
    }

    # HLS (fallback, higher compatibility)
    hls {
        enabled             on;
        hls_path            /tmp/hls;
        hls_fragment        1;
        hls_window          3;
        hls_cleanup         on;
        hls_wait_keyframe   on;
    }

    # SRS webhook callbacks to backend
    http_hooks {
        enabled         on;
        on_publish      http://backend:3001/api/v1/streaming/srs-auth;
        on_unpublish    http://backend:3001/api/v1/streaming/srs-done;
    }

    # Low-latency tuning
    tcp_nodelay     on;
    min_latency     on;
}
